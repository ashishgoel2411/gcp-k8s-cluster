pipeline {
 agent any
  environment {
     SVC_ACCOUNT_KEY = credentials('terraform-auth')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
         sh 'mkdir -p creds'
         sh 'echo $SVC_ACCOUNT_KEY | base64 -d > ./creds/demoaccount.json'
      }
    }	
    
	stage('TF Init') {
      steps {
        sh 'terraform init'
      }      
    }
	stage('TF Plan') {
      steps {
        sh 'terraform plan'
      }      
    }	
    stage('TF Apply') {
      steps {
        sh 'terraform apply -input=false -auto-approve'
      }
    }
    stage('Install Helm') {
      steps {
        sh 'curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3'
        sh 'chmod 700 get_helm.sh'
        sh './get_helm.sh'
      }
    }
    stage('Add Gremlin Helm Chart') {
      steps {
        sh 'helm repo add gremlin https://helm.gremlin.com'
      }
    }		
  }
}